# Story 1.2: Course Management System

## Status
Approved

## Story
**As a** student,
**I want** to set up my courses/modules during onboarding,
**so that** the AI can organize my files correctly.

## Acceptance Criteria
1. Onboarding wizard with welcome screen
2. Add courses with: name (required), term (required), code (optional), professor (optional), color (optional)
3. Visual course grid on dashboard
4. Edit/delete courses functionality
5. Term/semester management based on user's country/region:
   - North America: Semesters (Fall 2024, Spring 2025, Summer 2025)
   - UK: Terms (Michaelmas, Hilary, Trinity)
   - Germany: Semesters (Wintersemester, Sommersemester)
   - Netherlands: Periods/Blocks
6. Data persisted to Supabase
7. Country detection or selection during onboarding to determine academic system

## Tasks / Subtasks
- [ ] Create database schema for courses table (AC: 6)
  - [ ] Define courses table with proper fields
  - [ ] Set up Row Level Security policies
  - [ ] Create database migration
  - [ ] Test database operations
- [ ] Create API routes for course CRUD operations (AC: 2, 4, 6)
  - [ ] Implement GET /api/courses route
  - [ ] Implement POST /api/courses route
  - [ ] Implement PUT /api/courses/[id] route
  - [ ] Implement DELETE /api/courses/[id] route
  - [ ] Add authentication middleware to all routes
  - [ ] Add input validation and error handling
  - [ ] Implement rate limiting middleware
  - [ ] Add duplicate course detection
  - [ ] Enforce course limits per user
- [ ] Create course service layer (AC: 2, 4, 6)
  - [ ] Create lib/services/courses.service.ts
  - [ ] Implement CRUD methods using Supabase client
  - [ ] Add proper TypeScript types
  - [ ] Handle errors consistently
- [ ] Build onboarding wizard UI (AC: 1, 2, 5, 7)
  - [ ] Create app/onboarding/page.tsx with welcome screen
  - [ ] Create app/onboarding/layout.tsx for wizard layout
  - [ ] Implement country selection or detection step
  - [ ] Implement progress indicator component
  - [ ] Add smooth transitions between steps
  - [ ] Add skip option for quick start
  - [ ] Integrate with courses API
  - [ ] Show appropriate term options based on selected country
- [ ] Create course management components (AC: 2, 3, 4)
  - [ ] Create components/features/courses/CourseCard.tsx
  - [ ] Create components/features/courses/CourseForm.tsx
  - [ ] Create components/features/courses/CourseList.tsx
  - [ ] Implement emoji/color picker in CourseForm
  - [ ] Add hover states and animations
  - [ ] Implement form validation with error messages
  - [ ] Add delete confirmation dialog
  - [ ] Implement virtual scrolling for large lists
- [ ] Update dashboard to show course grid (AC: 3)
  - [ ] Modify app/(dashboard)/dashboard/page.tsx
  - [ ] Implement visual course grid layout
  - [ ] Add empty state for new users
  - [ ] Add navigation to course details
- [ ] Implement term/semester management (AC: 5, 7)
  - [ ] Add term selector component
  - [ ] Support different academic period types
  - [ ] Allow filtering courses by term
  - [ ] Implement smart term selection based on current date
  - [ ] Store terms in standardized format for i18n
- [ ] Set up Zustand store for course state (AC: All)
  - [ ] Update stores/useAppStore.ts with course state
  - [ ] Implement course actions (setCourses, addCourse, etc.)
  - [ ] Add optimistic updates for better UX
- [ ] Write unit tests for course functionality (Testing requirement)
  - [ ] Test course API routes
  - [ ] Test course service methods
  - [ ] Test CourseForm component
  - [ ] Test course state management

## Dev Notes

### Previous Story Insights
From Story 1.1 implementation:
- Supabase authentication is fully configured and working
- User profile table exists with proper RLS policies
- Middleware for route protection is implemented at middleware.ts
- Client/server Supabase instances are available at lib/supabase/
- OAuth integration is functional with proper redirect handling
- Environment variables are configured in .env.local
- Shadcn/ui components are installed and configured
- User profile includes country, timezone, and academic_system fields

### Data Models
Course data structure [Source: architecture/data-models.md#course]:
```typescript
interface Course {
  id: string;
  user_id: string;
  name: string;
  code?: string;
  professor?: string;
  term: string;
  academic_period_type: 'semester' | 'term' | 'trimester';
  credits?: number;
  ects_credits?: number;
  color: string;
  emoji?: string;
  created_at: Date;
  updated_at: Date;
}
```

Database schema for courses table [Source: architecture/database-schema.md#sql-schema-definition]:
```sql
CREATE TABLE courses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  code TEXT,
  professor TEXT,
  term TEXT NOT NULL,
  academic_period_type TEXT CHECK (academic_period_type IN ('semester', 'term', 'trimester')),
  credits INTEGER, -- US/Canada credits
  ects_credits INTEGER, -- European ECTS
  color TEXT NOT NULL DEFAULT '#3B82F6',
  emoji TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

Row Level Security policies needed:
- Enable RLS on courses table
- Policy: Users can only SELECT their own courses (user_id = auth.uid())
- Policy: Users can only INSERT courses for themselves (user_id = auth.uid())
- Policy: Users can only UPDATE their own courses (user_id = auth.uid())
- Policy: Users can only DELETE their own courses (user_id = auth.uid())

### API Specifications
API routes structure [Source: architecture/unified-project-structure.md]:
```
app/api/courses/
├── route.ts        # GET, POST /api/courses
└── [id]/
    └── route.ts    # GET, PUT, DELETE /api/courses/[id]
```

REST API patterns [Source: architecture/api-specification.md#rest-api-specification]:
- All endpoints require authentication via Supabase session
- Use consistent error response format
- Return proper HTTP status codes
- Validate input on server side

### Component Specifications
Component organization [Source: architecture/frontend-architecture.md#component-organization]:
```
components/features/courses/    # Course-specific components
├── CourseCard.tsx
├── CourseForm.tsx
├── CourseList.tsx
└── CourseDetails.tsx

app/(dashboard)/                # Protected dashboard routes
├── dashboard/
│   └── page.tsx               # Main dashboard with course grid
└── onboarding/
    ├── page.tsx               # Onboarding wizard
    └── layout.tsx             # Wizard layout wrapper
```

State management with Zustand [Source: architecture/frontend-architecture.md#state-management-architecture]:
```typescript
// stores/useAppStore.ts
interface AppState {
  // User state
  user: User | null;
  
  // Course state
  courses: Course[];
  selectedCourse: Course | null;
  isLoadingCourses: boolean;
  
  // Course actions
  setCourses: (courses: Course[]) => void;
  addCourse: (course: Course) => void;
  updateCourse: (id: string, updates: Partial<Course>) => void;
  deleteCourse: (id: string) => void;
  setSelectedCourse: (course: Course | null) => void;
}
```

### File Locations
Based on project structure [Source: architecture/unified-project-structure.md]:
- `app/onboarding/page.tsx` - Onboarding wizard main page
- `app/onboarding/layout.tsx` - Wizard layout wrapper
- `app/(dashboard)/dashboard/page.tsx` - Dashboard with course grid
- `app/api/courses/route.ts` - GET, POST course endpoints
- `app/api/courses/[id]/route.ts` - PUT, DELETE course endpoints
- `components/features/courses/CourseCard.tsx` - Course card component
- `components/features/courses/CourseForm.tsx` - Course creation/edit form
- `components/features/courses/CourseList.tsx` - Course list/grid component
- `lib/services/courses.service.ts` - Course service layer
- `stores/useAppStore.ts` - Global state management
- `types/index.ts` - TypeScript type definitions

### Testing Requirements
Testing framework and structure [Source: architecture/testing-strategy.md]:
- Use Vitest 1.2+ for unit testing
- Test files location: `__tests__/unit/` for unit tests
- Course-specific tests should go in:
  - `__tests__/unit/components/CourseForm.test.tsx`
  - `__tests__/unit/api/courses.test.ts`
  - `__tests__/unit/services/courses.service.test.ts`
- Use `@testing-library/react` for component testing
- Mock Supabase client for testing

Example test structure [Source: architecture/testing-strategy.md#frontend-component-test]:
```typescript
import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';

describe('CourseForm', () => {
  it('should create a new course', async () => {
    // Test implementation
  });
});
```

### Technical Constraints
Required technology versions [Source: architecture/tech-stack.md#technology-stack-table]:
- TypeScript 5.3+
- Next.js 14.1+
- Tailwind CSS 3.4+
- Shadcn/ui (already installed)
- Zustand 4.5+ for state management
- Supabase JS Client 2.39+
- Vitest 1.2+ for testing

Coding standards [Source: architecture/coding-standards.md#critical-fullstack-rules]:
- All shared types must be defined in the types/ directory
- Never make direct fetch calls from components - always use the service layer
- Access environment variables only through validated config objects
- Every API route must verify authentication before processing
- Use PascalCase for components, camelCase for functions/variables
- Use snake_case for database tables and columns

Service layer pattern [Source: architecture/frontend-architecture.md#service-example]:
```typescript
// lib/services/courses.service.ts
import { api } from '@/lib/api/client';
import type { Course } from '@/types';

export const coursesService = {
  async getCourses() {
    return api.get<Course[]>('/courses');
  },
  
  async createCourse(course: Partial<Course>) {
    return api.post<Course>('/courses', course);
  },
  
  async updateCourse(id: string, updates: Partial<Course>) {
    return api.put<Course>(`/courses/${id}`, updates);
  },
  
  async deleteCourse(id: string) {
    return api.delete(`/courses/${id}`);
  }
};
```

### Regional Academic Systems
Based on supported regions [Source: architecture/localization-architecture.md#supported-regions-languages]:
- **North America (US/Canada)**: 
  - Terms: Fall, Spring, Summer semesters
  - Academic year: August/September - May
  - GPA system for grades
- **UK**:
  - Terms: Michaelmas, Hilary/Lent, Trinity
  - Academic year: October - June
  - UK Honours system for grades
- **Germany**:
  - Terms: Wintersemester (Oct-Mar), Sommersemester (Apr-Sep)
  - ECTS credit system
- **Netherlands**:
  - Terms: Period/Block system (4-6 blocks per year)
  - ECTS credit system

The user's country selection during onboarding should:
1. Set appropriate term options in course creation
2. Configure the correct academic period type
3. Update user profile with country and academic_system

Country detection alternatives:
- Use browser's navigator.language for initial guess
- IP-based geolocation (requires additional service)
- Manual selection during onboarding (recommended for accuracy)

### Form Validation Rules
Course field validation requirements:
- **Course name**: Required, 2-100 characters, allow letters, numbers, spaces, hyphens, and parentheses
- **Course code**: Optional, max 20 characters, format examples: "CS101", "MATH-200", "BIO 303L"
- **Professor name**: Optional, max 100 characters, letters, spaces, hyphens, apostrophes
- **Term**: Required, must match user's academic system options
- **Color**: Optional, limited to predefined palette of 12 colors for consistency
- **Emoji**: Optional, limited to education-related emoji set

### Error Handling Scenarios
Specific error cases to implement:
- **Duplicate detection**: Prevent duplicate course name + term combinations
- **Network failures**: Show retry option with cached form data
- **Concurrent editing**: Use optimistic locking with version field
- **Course limits**: Maximum 20 courses per term, 100 total courses per user
- **Graceful degradation**: Queue failed requests for retry when online

### Performance Considerations
- **Large course lists**: Implement virtual scrolling for >50 courses
- **Form inputs**: Debounce validation by 300ms
- **Optimistic updates**: Update UI immediately, rollback on API failure
- **Lazy loading**: Load full course details only when card is expanded
- **Caching**: Cache course list in Zustand with 5-minute TTL

### Data Migration & Defaults
- **Smart term selection**: Auto-select current academic term based on:
  - User's region and current date
  - Most recently used term if within valid range
- **Existing users**: Migration script to set academic_system based on country
- **Fallback**: If country not set, prompt during first course creation

### Security Considerations
- **Input sanitization**: Strip HTML/script tags from all text inputs
- **Rate limiting**: Max 10 course creations per minute per user
- **Field lengths**: Enforce maximum lengths in both frontend and API
- **SQL injection**: Use parameterized queries (Supabase handles this)

### UX Polish Details
- **Empty states**: 
  - New user: "Welcome! Let's add your first course"
  - No courses in term: "No courses for this term yet"
- **Tooltips**: 
  - Course code: "e.g., CS101, MATH-200 (optional)"
  - Color: "Choose a color to organize your courses"
- **Smart defaults**:
  - Pre-select current/upcoming term
  - Default color cycles through palette
- **Delete confirmation**: "Delete [Course Name]? This won't delete your files."

### Internationalization Prep
- **Term storage**: Store term as `{year}_{period_type}` (e.g., "2024_fall", "2024_wintersemester")
- **Display names**: Use i18n keys for term display names
- **Date formats**: Format term dates according to user's locale
- **RTL support**: Use logical CSS properties (margin-inline-start vs margin-left)
- **Emoji**: Ensure emoji render correctly across different OS/browsers

### Accessibility Requirements
- **Color contrast**: Ensure 4.5:1 ratio for text on course card backgrounds
- **Alternative identification**: Add patterns or icons in addition to colors
- **Focus indicators**: Clear focus rings on all interactive elements
- **Error announcements**: Use aria-live regions for form errors

### Project Structure Notes
The project follows the established structure from architecture/unified-project-structure.md. All new files should be placed in their designated locations according to the structure guide. The onboarding flow will be a new addition under app/onboarding/, while course management components will go under components/features/courses/.

## Testing

### Testing Standards
- Test file location: `__tests__/unit/` for unit tests, organized by type:
  - `__tests__/unit/components/` for React component tests
  - `__tests__/unit/api/` for API route tests
  - `__tests__/unit/services/` for service layer tests
- Testing framework: Vitest 1.2+ with @testing-library/react
- Mock Supabase client for unit tests using vi.mock()
- Test coverage requirements:
  - All API routes must have tests for success and error cases
  - Component tests should cover user interactions and state changes
  - Service layer tests should verify proper API calls
- Follow the testing patterns defined in architecture/testing-strategy.md
- Use proper test isolation - each test should be independent
- Test naming convention: describe blocks for components/functions, it blocks for specific behaviors

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-27 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-07-27 | 1.1 | Updated AC2 to make only name and term required; Added AC7 for country detection/selection; Added regional academic system details | Bob (Scrum Master) |
| 2025-07-27 | 1.2 | Added comprehensive best practices: form validation rules, error handling, performance optimizations, security measures, UX polish, i18n prep, and accessibility requirements | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results