# Story 1.1: Next.js Project Setup & Authentication

## Status
Draft

## Story
**As a** developer,
**I want** to set up the Next.js project with Supabase authentication,
**so that** users can create accounts and log in securely.

## Acceptance Criteria
1. Next.js 14 project created with App Router and TypeScript
2. Supabase project configured with authentication
3. Sign up with email/password
4. Email verification flow
5. Sign in/out functionality
6. Password reset capability
7. Protected routes middleware
8. Session persistence
9. Google OAuth authentication
10. Microsoft OAuth authentication

## Tasks / Subtasks
- [ ] Initialize Next.js 14 project with TypeScript (AC: 1)
  - [ ] Run create-next-app with TypeScript template
  - [ ] Configure App Router structure
  - [ ] Set up project structure according to architecture
  - [ ] Install and configure Tailwind CSS 3.4+
  - [ ] Install Shadcn/ui components library
- [ ] Set up Supabase integration (AC: 2, 9, 10)
  - [ ] Create Supabase project
  - [ ] Install @supabase/auth-helpers-nextjs package
  - [ ] Create lib/supabase/client.ts for client-side auth
  - [ ] Create lib/supabase/server.ts for server-side auth
  - [ ] Configure environment variables in .env.local
  - [ ] Enable Google OAuth provider in Supabase dashboard
  - [ ] Enable Microsoft OAuth provider in Supabase dashboard
  - [ ] Configure OAuth redirect URLs for both providers
- [ ] Implement authentication pages (AC: 3, 4, 5, 6, 9, 10)
  - [ ] Create app/(auth)/login/page.tsx with sign-in form
  - [ ] Create app/(auth)/register/page.tsx with sign-up form
  - [ ] Create app/(auth)/reset-password/page.tsx for password reset
  - [ ] Create app/(auth)/layout.tsx for auth layout
  - [ ] Implement email verification handling
  - [ ] Add Google OAuth sign-in button and flow
  - [ ] Add Microsoft OAuth sign-in button and flow
  - [ ] Configure OAuth redirect callbacks
- [ ] Set up middleware for route protection (AC: 7, 8)
  - [ ] Create middleware.ts in project root
  - [ ] Implement authentication check for protected routes
  - [ ] Configure session persistence with Supabase
  - [ ] Handle redirect logic for unauthenticated users
- [ ] Create initial database schema (Supporting infrastructure)
  - [ ] Set up user_profiles table as defined in schema
  - [ ] Configure RLS policies for user data access
  - [ ] Create database migrations
- [ ] Write unit tests for authentication flows (Testing requirement)
  - [ ] Test sign up flow with email verification
  - [ ] Test sign in/out functionality
  - [ ] Test password reset flow
  - [ ] Test middleware route protection
  - [ ] Test Google OAuth authentication flow
  - [ ] Test Microsoft OAuth authentication flow

## Dev Notes

### Previous Story Insights
No previous story - this is the first story of the project.

### Data Models
User profile data structure from database schema [Source: architecture/database-schema.md#sql-schema-definition]:
```sql
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  full_name TEXT,
  university TEXT,
  avatar_url TEXT,
  preferred_locale TEXT DEFAULT 'en-US',
  country TEXT NOT NULL,
  timezone TEXT NOT NULL DEFAULT 'UTC',
  academic_system TEXT CHECK (academic_system IN ('gpa', 'ects', 'uk_honours', 'percentage')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

TypeScript interface for User [Source: architecture/data-models.md#user]:
```typescript
interface User {
  id: string;
  email: string;
  full_name: string;
  university?: string;
  preferred_locale: string;
  country: string;
  timezone: string;
  academic_system: 'gpa' | 'ects' | 'uk_honours' | 'percentage';
  created_at: Date;
  avatar_url?: string;
}
```

### API Specifications
No specific API endpoints for this story - Supabase handles auth endpoints internally.

OAuth Configuration:
- Google OAuth requires Google Cloud Console setup with OAuth 2.0 credentials
- Microsoft OAuth requires Azure AD app registration
- Redirect URLs will be: 
  - `{SITE_URL}/auth/callback` for production
  - `http://localhost:3000/auth/callback` for development
- Supabase will handle the OAuth flow after provider configuration

### Component Specifications
Auth group structure [Source: architecture/frontend-architecture.md#component-organization]:
```
app/
├── (auth)/
│   ├── login/
│   │   └── page.tsx
│   ├── register/
│   │   └── page.tsx
│   └── layout.tsx
```

Protected route pattern with middleware [Source: architecture/frontend-architecture.md#protected-route-pattern]:
```typescript
// middleware.ts
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';
import { NextResponse } from 'next/server';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });
  
  const { data: { session } } = await supabase.auth.getSession();
  
  // Protect dashboard routes
  const isDashboardRoute = pathname.includes('/(dashboard)');
  if (isDashboardRoute && !session) {
    return NextResponse.redirect(new URL('/login', req.url));
  }
  
  return res;
}
```

### File Locations
Based on project structure [Source: architecture/unified-project-structure.md]:
- `app/(auth)/login/page.tsx` - Login page
- `app/(auth)/register/page.tsx` - Registration page
- `app/(auth)/reset-password/page.tsx` - Password reset page
- `app/(auth)/layout.tsx` - Auth layout wrapper
- `lib/supabase/client.ts` - Client-side Supabase instance
- `lib/supabase/server.ts` - Server-side Supabase instance
- `middleware.ts` - Route protection middleware
- `types/index.ts` - TypeScript type definitions
- `.env.local` - Environment variables

### Testing Requirements
Testing framework and structure [Source: architecture/testing-strategy.md]:
- Use Vitest 1.2+ for unit testing
- Test files location: `__tests__/unit/` for unit tests
- Auth-specific tests should go in `__tests__/unit/auth/`
- Use `@testing-library/react` for component testing
- Mock Supabase client for testing

Example test structure [Source: architecture/testing-strategy.md#frontend-component-test]:
```typescript
import { render, screen } from '@testing-library/react';
// Test structure follows the pattern shown in architecture
```

### Technical Constraints
Required technology versions [Source: architecture/tech-stack.md#technology-stack-table]:
- TypeScript 5.3+
- Next.js 14.1+
- Tailwind CSS 3.4+
- Supabase Auth 2.0+
- Vitest 1.2+ for testing

Coding standards [Source: architecture/coding-standards.md#critical-fullstack-rules]:
- All shared types must be defined in the types/ directory
- Never make direct fetch calls from components - always use the service layer
- Access environment variables only through validated config objects
- Every API route must verify authentication before processing

OAuth Implementation Notes:
- Use Supabase's built-in OAuth handling with signInWithOAuth()
- Store OAuth provider info in user metadata
- Handle both email/password and OAuth users uniformly in the app
- Ensure OAuth users can still update their profile information

## Testing

### Testing Standards
- Test file location: `__tests__/unit/auth/` for authentication tests
- Testing framework: Vitest 1.2+ with @testing-library/react
- Mock Supabase auth client for unit tests
- Test coverage requirements:
  - All authentication flows must have tests
  - Middleware protection logic must be tested
  - Form validation and error handling must be tested
- Follow the testing patterns defined in architecture/testing-strategy.md

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-27 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-07-27 | 1.1 | Added Google OAuth and Microsoft OAuth authentication | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]